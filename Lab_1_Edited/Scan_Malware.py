#!/usr/bin/python

import os
import subprocess as sp

files = os.listdir('/home/mangesh/Downloads/malware_data_science/ch8/data/malware/') # Path to malware files directory

for file in files: # Loop through all files in the directory and extract features
    file = "/home/mangesh/Downloads/malware_data_science/ch8/data/malware/" + file # Path to malware files directory + file name
    stream = os.popen("md5sum " + file) # Get MD5 hash of the file using md5sum
    hvalue = stream.read() # Read the output of the md5sum command and store it in a variable
    hvalue = hvalue.split()[0] # Split the output of the md5sum command and store the first element in a variable
    proc = sp.Popen(["/home/mangesh/Downloads/capa", "-v", file], stdout=sp.PIPE, universal_newlines=True) # Run capa on the malware file and store the output in a variable
    output, error = proc.communicate() # Read the output of the capa command and store it in a variable 
    layer = output.split("\n\n") # Split the output of the capa command and store it in a variable
    layer.pop(0) # Remove the first element of the list 
    feat = [] # Create an empty list to store the features of the malware file
    feat.append(hvalue) # Append the MD5 hash of the malware file to the list of features
    feat.append(1) # Append the label of the malware file to the list of features

    for element in layer: # Loop through all the elements in the list and append them to the list of features
        if element == "": # If the element is an empty string, continue to the next element
            continue # Continue to the next element in the list
        else: # If the element is not an empty string, append it to the list of features
            element = element.split("\n") # Split the element and store it in a variable 
            if "(." in element[0]: # If the first element of the list contains a dot, append it to the list of features
                feat.append(element[0]) # Append the element to the list of features 
            elif "(" in element[0]: # If the first element of the list contains a bracket, append it to the list of features
                ls_element = element[0].split("(")[0] # Split the element and store the first element in a variable
            else: # If the first element of the list does not contain a dot or a bracket, append it to the list of features
                feat.append(element[0]) # Append the element to the list of features 
    print("Examined files: ", file) # Print the name of the file that is being examined 
    print(feat) # Print the list of features of the malware file 
    with open("/home/mangesh/Downloads/features.csv", "a") as f: # Open the file features.csv in append mode and store it in a variable
        f.write(str(feat)) # Write the list of features to the file features.csv 
        f.write("\n") # Write a new line to the file features.csv 
    f.close() # Close the file features.csv 

# Path: Scan_Malware.py
# Code guides - Aditi Singh and Dr. Asma Paracha
# Code editor - Mangesh Bhattacharya